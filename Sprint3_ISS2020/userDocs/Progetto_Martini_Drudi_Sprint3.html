<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <!--
<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
<script type="text/javascript" src="../css/issStyle.js"></script>
-->
<style type="text/css">
<!--
body
{
    margin-left:  30px;
    margin-right: 30px;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #1F37B5;
    background-color: transparent;
}

a:hover {
    background-color: #cccccc;
}
h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin: 10;
	border-radius: 10px;
	padding: 5px;
}

h1 {
    font-size: 150%;
    background-color: #b2c0ff;
}

h2 {
    background-color: #9ed8ff;
    font-size: 110%;
}

h3 {
	background-color: #e6ccff;
    font-size: 80%;
}
h4 {
    background-color: #C0F0E0;
    font-size: 100%;
	width: 100%;
	border-radius: 5px;
	padding: 5px;
}
h5 {
    background-color: #d5ffb0;
    font-size: 90%;
	border-radius: 5px;
	padding: 3px;
	padding-top: 0;
	margin-top: 0;
	
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #abe876;
    color: #154A7E;
	padding: 1px;
	border-radius: 5px;
}
ks{
	background-color: #E8FFD3;
	padding: 1px;
	padding-left: 3px;
	padding-right: 3px;
	border-radius: 5px;
	 
}
pre{
	font-family: "Consolas";
	font-size: 80%;
	background-color: #F8FFFD;
	border: 1.5px solid #90E4C8;
	padding: 10px;
	border-radius: 10px;
	overflow-x: auto;
	white-space: pre-wrap;
	white-space: -moz-pre-wrap;
	white-space: -pre-wrap;
	white-space: -o-pre-wrap;
	word-wrap: break-word;
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
    font-size: 19px;
	line-height: 110%;
}    
div.cit{
	padding: 10px;
	margin: 5px;
    font-size: 18px;
	background-color: #EFF9F6;
	border-radius: 25px;
	border: 1px solid #d5f2ed;
}       
div.remark{
	background-color: #ffffff;	
    border: 1.5px solid #d5f2ed;
	padding-left: 20px;
	padding-right: 30px;
    margin: 10px;
	border-radius: 25px;
}  
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}

ul{
	margin: 10px;
	margin-left: 20px;
	padding: 0;
}

li{
	padding-top: 5px;
}

table, th, td {
	border: 2px solid #d5f2ed;
}
td{
	padding: 10px;
}

#authors {
	width: 600px;
	border: 2px solid #AB55FF;
}

#authors td {
    background-color: #b2c0ff;
	padding: 10px;
	border: 2px solid #AB55FF;
}
i{
	font-weight: bold;
}
tl, ttr{
	color: #154A7E;
	font-weight: bold;
}
ttr{
	font-style: italic;
}
.mytab{
	tab-size: 4;
}
keyw{
	color: #B12283;
	font-weight: bold;
}
comm{
	color: #00BD06;
}
strs{
	color: #145CDE;
}
ints{
	color: #E7BE41;
	}
p.did{
	margin: 0;
	padding-bottom: 10px;
	padding-top: 0;
	padding-left: 15px;
	padding-right: 5px;
	font-size: 18px;
	border-left: 2px dashed silver;
}
sevid{
	background-color: #A8ECC7;
	border-radius: 5px;
	padding: 2px;
}
tevid{
	border-radius: 5px;
	padding: 2px;
	border: 2px solid #A8ECC7;
	line-height: 24px;
}
mevid{
	background-color: #D4F7E4;
}
change_evid{
	background-color: #FFFF99;
	border-radius: 5px;
	padding: 2px;
}
schange_evid{
	background-color: #FFE699;
	border-radius: 5px;
	padding: 2px;
}
tchange_evid{
	border-radius: 5px;
	padding: 2px;
	border: 2px solid #FFE699;
	line-height: 24px;
}
video{
	margin: 30px;
  -->
</style>
    
<head>
   
<title>Tearoom - sprint 3</title></head>
    
<body>
<div id="top">
<h1>Safe Tearoom COVID-19 - Sprint 3<font size="5"></font> </h1>
</div>  

<div class="body"> 

<!--<h2>Introduction</h2>
<div class="remark">
</div>-->

<h2>Requirements</h2>
<div class="remark">
	<h4>Assumptions for Sprint 3</h4>
	<p>The assumptios made for the third sprint can be found here: <a href="https://htmlpreview.github.io/?https://github.com/gitemar/Martini_Drudi_ISS2020/blob/master/Sprint3_ISS2020/userDocs/Documento_Martini_Drudi_Sprint3.html#assumption">Assumptions Sprint 3</a>
</div>

<h2>Project</h2>
<div class="remark">
	<h4>Structure</h4>
	<div>
		<ul>
			<li><h5>Logical Architecture</h5>
				<p>The logical architecture of our System remained unchanged and is represented by the image below. </p>
				<center><img src="img/prog_architecture.PNG" alt="logical architecture" width="100%"/></center>		
			</li>
			</br>
			<li>
				<h5>Manager architecture</h5>
				The Manager architecture remained unchanged too and is summarized in the image below.  
				</br></br>
				<center><img src="img/proj_manager.png" alt="logical architecture" width="70%"/></center>
			</li></br>
			<li>
				<h5>Waiter architecture</h5>
				
				The Waiter architecture has not changed compared to what was defined in the <a href="https://htmlpreview.github.io/?https://github.com/gitemar/Martini_Drudi_ISS2020/blob/master/Sprint1_ISS2020/userDocs/Progetto_Martini_Drudi_Sprint1.html">Sprint 1 project document</a>.
				

			</li>
		</ul>
	</div>
	<h4>Interaction</h4>
	<div>
		<p> No new form of interaction has been introduced in this third sprint, therefore what discussed in Sprint 1 and Sprint 2 remains valid.</p>
	</div>
	<h4>Behaviour</h4>
	<div>
	<p>Compared to the previous Problem Analysis and Sprints only the waiter has undergone some changes. Hereunder is reported the waiter qak model and the changes are highlighted.</p>
		<ul>
			<li><h5>Waiter QAK behaviour</h5>
			<pre class="mytab"><code><keyw>System</keyw> waiter
			
<keyw>mqttBroker</keyw> <strs>"localhost"</strs> : <ints>1883</ints> <keyw>eventTopic</keyw> "unibo/polar" 	<comm>//mqtt.eclipse.org</comm>

<comm>// Interaction Waiter - Mover =================================//</comm>
<keyw>Request</keyw> moveTo 	: moveTo(KEY_POSITION)						   
<keyw>Reply</keyw> done 		: done(X,Y)									   
<keyw>Dispatch</keyw> end 	: end(ARG)									  
<comm>//=============================================================//</comm>

<comm>// Interaction Mover - TrustingWalker ==========================//</comm>
<keyw>Event</keyw>    twstarted  : twstarted(X)		    <comm>// emitted by TrustingWalker after it started</comm>
<keyw>Request</keyw>  movetoCell : movetoCell(X,Y)		<comm>// move to position (X,Y) with X column and Y row</comm>
<keyw>Reply</keyw>   atcell     : atcell(X,Y)			<comm>  // if success TrustingWalker send this message</comm>
<keyw>Reply</keyw>	 walkbreak  : walkbreak(X,Y) 		<comm>// if fail TrustingWalker send this message </comm>
<comm>//=============================================================//</comm>

<comm>// Interaction Waiter - MasterTimer =================================//</comm>
<keyw>Dispatch</keyw> startTimer 	: startTimer(TEATABLE_ID, MAX_TIME)	   
<keyw>Dispatch</keyw> stopTimer 	: stopTimer(TEATABLE_ID)			   
<keyw>Dispatch</keyw> resumeTimer 	: resumeTimer(TEATABLE_ID)			   
<keyw>Dispatch</keyw> endTimer 		: endTimer(TEATABLE_ID)				   
<keyw>Dispatch</keyw> timeout 		: timeout(TEATABLE_ID)				   
<comm>//=============================================================//</comm>

<comm>// Interaction Waiter - Tearoom ========================================//</comm>
<keyw>Request</keyw> getRoomState : getRoomState(REQUEST, ARG1)						
<keyw>Reply</keyw> state			 : state(STATE)										
<keyw>Dispatch</keyw> updateState : updateState (UPDATE_REQUEST, ARG1, ARG2, ARG3)	
<comm>//======================================================================//</comm>

<comm>// Interaction Waiter - Smartbell ============================//</comm>
<keyw>Dispatch</keyw> enter : enter(CLIENT_ID)						      
<comm>//============================================================//</comm>

<comm>// Interaction Waiter - Client ===============================//</comm>
<keyw>Event</keyw> wait 				: wait(CLIENT_ID, MAX_TIME)			 
<keyw>Event</keyw> sitPlease 		: sitPlease(CLIENT_ID, TEATABLE_ID)   
<keyw>Dispatch</keyw> wantToOrder	: wantToOrder(TEATABLE_ID)	          
<keyw>Event</keyw> orderPlease		: orderPlease(ARG)					  
<keyw>Dispatch</keyw> tea 			: tea(TEATABLE_ID, TEA)				  
<keyw>Event</keyw> teaServed 		: teaServed(TEATABLE_ID, TEA)		  
<keyw>Dispatch</keyw> billPlease 	: billPlease(TABLE_ID)				  
<keyw>Event</keyw> cardPlease 		: cardPlease(ARG)					  
<keyw>Event</keyw> maxTimeExceeded 	: maxTimeExceeded(TEATABLE_ID)		  
<keyw>Event</keyw> exitPlease 		: exitPlease(CLIENT_ID)				  
<comm>//============================================================//</comm>

<comm>// Interaction Waiter - Barman  ==============================//</comm>
<keyw>Dispatch</keyw> order : order(TEATABLE_ID, TEA)					  
<keyw>Dispatch</keyw> ready : ready(TEATABLE_ID,TEA)						  
<comm>//============================================================//</comm>

<comm>// Interaction Waiter auto-message ===========================//</comm>
<keyw>Dispatch</keyw> cleanTable : cleanTable (TEATABLE_ID)				  
<comm>//============================================================//</comm></code></pre>

		<pre class="mytab"><code>Context ctxwaiter 		 	ip [host="127.0.0.1" port=8029]
Context ctxtearoom 		 	ip [host="localhost" port=8015]

ExternalQActor tearoom 		context ctxtearoom
ExternalQActor barman		context ctxtearoom
ExternalQActor smartbell	context ctxtearoom

CodedQActor datacleaner    	context ctxwaiter className "rx.dataCleaner"
CodedQActor distancefilter 	context ctxwaiter className "rx.distanceFilter"
CodedQActor basicrobot 		context ctxwaiter className "it.unibo.basicrobot.Basicrobot"
CodedQActor trustingwalker 	context ctxwaiter className "it.unibo.trustingwalker.Trustingwalker"
CodedQActor mastertimer		context ctxwaiter className "it.unibo.mastertimer.Mastertimer"



<sevid>QActor waiter</sevid> context ctxwaiter {
	[# 
		var MaxWaitTime = 0L
		val MaxStayTime = 10000L   	// 10 sec
		val IdleTime = 200L			// 200 ms
		
		var ClientToConvoy = ""
		var DestTable = -1
		var CurDrink = ""
		var Price = 3
		
		var TimeToClean = 2000L
		var TimeCleanBegan = 0L
		var WasCleaning = false
		var TableToClean = 0
	#]
	
	<sevid>State s0 initial</sevid>{
		//init
		println("waiter | beep beep boop...START...")
		discardMsg Off
	}
	<tevid>Goto restingAtHome</tevid>
	
	<comm>// WAITER WAIT FOR TASK TO DO 1</comm>
	<sevid>State restingAtHome</sevid>{
	
		println("waiter | Chilling out at home...")	
		updateResource[#"atPosition(0,0,home)"#]
			
	}
	<tevid>Transition t0   whenMsg enter -> handleEnterPhase1</tevid>
					<tevid>whenMsg wantToOrder -> handleOrderFromClientPhase1</tevid>
					<tevid>whenMsg ready -> serveTeaToClientPhase1</tevid>
					<tevid>whenMsg timeout -> handleTimeoutPhase1</tevid>
					<tevid>whenMsg billPlease -> handlePaymentPhase1 </tevid>
					<tevid>whenMsg cleanTable -> cleanTeatablePhase1</tevid>
					
	<comm>// WAITER WAIT FOR TASK TO DO 2</comm>				
	<sevid>State doATask</sevid>{
	
		println("waiter | checking if there is a task to do...")
		
	}
	<tevid>Transition t0   whenTimeVar IdleTime -> goHome</tevid> <comm>// if waiter has no task it go home to rest a little bit</comm>
					<tevid>whenMsg enter -> handleEnterPhase1</tevid>
					<tevid>whenMsg wantToOrder -> handleOrderFromClientPhase1</tevid>
					<tevid>whenMsg ready -> serveTeaToClientPhase1</tevid>
					<tevid>whenMsg timeout -> handleTimeoutPhase1</tevid>
					<tevid>whenMsg billPlease -> handlePaymentPhase1 </tevid>
					<tevid>whenMsg cleanTable -> cleanTeatablePhase1</tevid>
					
	<comm>// WAITER GO HOME	</comm>
	<sevid>State goHome</sevid> {
		
		updateResource[#"goingHome"#]
		<mevid>request mover -m moveTo : moveTo(home)</mevid>
		
	}
	<tevid>Transition t0 whenReply done -> restingAtHome</tevid>


	<comm>/******************************  WAITER HANDLE ENTER REQUEST **************************************/</comm>
	
	<sevid>State handleEnterPhase1</sevid> {
		println("waiter | enter message arrived")
		onMsg(enter : enter(CLIENT_ID)){
			
			if [# WasCleaning == true #]{
				[# var TempTime = 0L #]
				memoCurrentTime TempTime
				[# TimeToClean = TimeToClean - (TempTime - TimeCleanBegan) #]
				println("waiter | interrupted cleaning to handle enter request")
			}
			
			[#ClientToConvoy = payloadArg(0)#]
			
			println("waiter | a client with client_id ${payloadArg(0)} asked to enter the safe tearoom...")
			println("waiter | checking if the safe tearoom has a free table ...")
			<mevid>request tearoom -m getRoomState : getRoomState(getFreeTable, arg1)</mevid>
		} //onMsg
		
	}
	<tevid>Transition t0 whenReply state -> handleEnterPhase2</tevid>
	
	<sevid>State handleEnterPhase2</sevid> {
		
		onMsg(state : state(S)){
			if [#payloadArg(0).toInt() == 0 #] { <comm>//NO free and clean table</comm>
				[# MaxWaitTime =  1L #]
				println("waiter | But there is no free and clean teatable"
			}
			else { <comm>// there is a free and clean table and Tearoom sent me it's ID</comm>
				[# 
					MaxWaitTime =  0L
					DestTable = payloadArg(0).toInt()
				#]
			}
		}
	}
	<tevid>Goto convoyClientToTablePhase1 if [# MaxWaitTime == 0L #] else requestTableStates</tevid>
	
	<sevid>State requestTableStates</sevid>{
	
		println("waiter | requesting teatable states to tearoom...")
		request tearoom -m getRoomState : getRoomState(getBusyAndDirtyTables, arg1)
		
	}
	<tevid>Transition t0 whenReply numBusyAndDirty -> analyzeTableStates</tevid>
	
	<schange_evid>State analyzeTableStates{</schange_evid>
	
		onMsg(numBusyAndDirty : numBusyAndDirty(B,D)){
			println("waiter | tearoom replied with ${payloadArg(0)}-${payloadArg(1)} (busy-dirty)")
			<change_evid>[#</change_evid>
				<change_evid>val b=payloadArg(0).toInt()</change_evid>
				<change_evid>val d=payloadArg(1).toInt()</change_evid>
				<change_evid>var totTime = 0L</change_evid>
				<change_evid>if(d>0){</change_evid>
					<change_evid>totTime = MaxCleanTime</change_evid>
				<change_evid>}</change_evid>
				<change_evid>else{</change_evid>
					<change_evid>totTime = MaxStayTime</change_evid>
				<change_evid>}</change_evid>
				<change_evid>MaxWaitTime = totTime</change_evid>
			<change_evid>#]</change_evid>
			delay 800
			println("waiter | client has to wait at least $MaxWaitTime minutes")
			emit wait : wait($ClientToConvoy,$MaxWaitTime)
		}
	}
	<tchange_evid>Goto doATask if [# WasCleaning == false #] else cleanTeatablePhase1</tchange_evid>
	
	<comm>/****************************************************************************************************/</comm>
	
	<comm>/******************************  WAITER CONVOY CLIENT TO TABLE **************************************/</comm>
	
	<sevid>State convoyClientToTablePhase1</sevid> {
		updateResource[#"convoyingClientToTable($DestTable,$ClientToConvoy)"#]
		println("waiter | reaching entrance door to convoy client $ClientToConvoy to teatable $DestTable ...")
		<mevid>request mover -m moveTo : moveTo(entrance)</mevid>
	}
	<tevid>Transition t0 whenReply done -> convoyClientToTablePhase2</tevid>
	
	<sevid>State convoyClientToTablePhase2</sevid> {
		<mevid>emit wait : wait($ClientToConvoy , $MaxWaitTime)</mevid>
		println("waiter | convoying client $ClientToConvoy to teatable $DestTable ...")
		[#var Dest =  "teatable" + DestTable.toString() #]
		<mevid>request mover -m moveTo : moveTo($Dest)</mevid>
	}
	<tevid>Transition t0 whenReply done -> convoyClientToTablePhase3</tevid>
		
	<sevid>State convoyClientToTablePhase3</sevid> {
		
		println("waiter | Start mastertimer, update tearoom and telling client to sit")
		<mevid>forward tearoom -m updateState : updateState (updateTableState, $DestTable, busy, $ClientToConvoy)</mevid>
		<mevid>emit sitPlease : sitPlease($ClientToConvoy, $DestTable )</mevid>
		<comm>//start timer to count until MaxStayTime</comm>
		<mevid>forward mastertimer -m startTimer : startTimer($DestTable, $MaxStayTime)</mevid>
		
	}
	<tevid>Goto doATask if [# WasCleaning == false #] else cleanTeatablePhase1</tevid>
	
	<comm>/****************************************************************************************************/</comm>
	
	<comm>/**************************************  WAITER CLEAN TABLE **************************************/</comm>
	
	<sevis>State cleanTeatablePhase1</sevid> {
		
		[# var Dest="" #]
		
		onMsg(cleanTable : cleanTable(T)) {
		
			println("Waiter moving towards teatable to clean (${payloadArg(0)})")
			[#
			  Dest =  "teatable" + payloadArg(0) 
			  DestTable = payloadArg(0).toInt()
			  TableToClean = payloadArg(0).toInt()
			#]
		}
		
		<comm>//resuming cleaning if waiter was cleaning</comm>
		if[# WasCleaning == true #]{
			println("Waiter moving towards teable $TableToClean to resume cleaning")
			[#
			  Dest =  "teatable" + TableToClean
			  DestTable = TableToClean
			#]
		}
		
		updateResource[#"cleaning($DestTable)"#]
		
		<comm>//first we reach the table</comm>
		<mevid>request mover -m moveTo : moveTo($Dest)</mevid>
	}
	<tevid>Transition t0 whenReply done -> cleanTeatablePhase2</tevid>
	
	
	<sevid>State cleanTeatablePhase2</sevid> {
		
		<comm>// then we clean the teatable</comm>
		println("waiter | cleaning the teatable ${payloadArg(0)}")
		[#
			WasCleaning = true
		#]
		memoCurrentTime TimeCleanBegan					
	}
	<tevid>Transition t1 whenTimeVar TimeToClean -> finishedClean</tevid>
				  <tevid>whenMsg ready -> serveTeaToClientPhase1</tevid>
				  <tevid>whenMsg enter -> handleEnterPhase1</tevid>
				  <tevid>whenMsg wantToOrder -> handleOrderFromClientPhase1</tevid>
				  <tevid>whenMsg billPlease -> handlePaymentPhase1</tevid>
	
	
	<sevid>State finishedClean</sevid>{
		
		println("waiter | finished cleaning teatable $TableToClean")
		<comm>//update teatable state</comm>
		<mevid>forward tearoom -m updateState : updateState (updateTableState, $TableToClean, clean, ARG3)</mevid>
		[# 
			WasCleaning = false
			TimeToClean = 2000L
			TableToClean = 0
			TimeCleanBegan = 0L
		#]
	}
	<tevid>Goto doATask</tevid>
	
		
	<comm>/****************************************************************************************************/</comm>
	
	<comm>/**************************************  WAITER TAKE CLIENT's ORDER **************************************/</comm>	
		
	
	<sevid>State handleOrderFromClientPhase1</sevid> {
		
		onMsg(wantToOrder : wantToOrder(TEATABLE_ID)){
		
			if [# WasCleaning == true #]{
				[# var TempTime = 0L #]
				memoCurrentTime TempTime
				[# TimeToClean = TimeToClean - (TempTime - TimeCleanBegan) #]
				println("waiter | interrupted cleaning to handle order request")
			}
			<comm>//Stop timer </comm>
			<mevid>forward mastertimer -m stopTimer : stopTimer($payloadArg(0))</mevid>
			println("waiter | client at teatable ${payloadArg(0)} want to order! Reaching table ${payloadArg(0)}...")
			<comm>// reach teatable to take client order</comm>
			[#var 
				Dest =  "teatable" + payloadArg(0)
				DestTable = payloadArg(0).toInt()
			#]
			updateResource[#"takingOrder(${payloadArg(0)})"#]
			<mevid>request mover -m moveTo : moveTo($Dest)</mevid>
		}
	}
	<tevid>Transition t0 whenReply done -> handleOrderFromClientPhase2</tevid>
	
	
	<sevid>State handleOrderFromClientPhase2</sevid> {
		
		println("waiter | client can now order..."
		<mevid>emit orderPlease : orderPlease(ARG)</mevid>
	}
	<tevid>Transition t0 whenMsg tea -> handleOrderFromClientPhase3</tevid>
	
	
	<sevid>State handleOrderFromClientPhase3</sevid> {
		
		onMsg(tea : tea(TABLE,TEA)){
			println("waiter | client at teatable ${payloadArg(0)} ordered a ${payloadArg(1)}! Sending order to Barman...")
			<mevid>forward barman -m  order : order($payloadArg(0), $payloadArg(1))</mevid>
		}
		
	}
	<tevid>Goto cleanTeatablePhase1 if [# WasCleaning == true #] else doATask</tevid>
	
	
	<comm>/****************************************************************************************************/</comm>
	
	<comm>/**************************************  WAITER SERVE CLIENT  **************************************/</comm>
	
	<sevid>State serveTeaToClientPhase1</sevid> {
		onMsg(ready : ready(T,D)){
			
			if [# WasCleaning == true #]{
				[# var TempTime = 0L #]
				memoCurrentTime TempTime
				[# TimeToClean = TimeToClean - (TempTime - TimeCleanBegan) #]
				println("waiter | interrupted cleaning to serve")
			}
			[# 
				DestTable = payloadArg(0).toInt()
				CurDrink = payloadArg(1)
			#]
			println("waiter | order for table ${payloadArg(0)} ready! Reaching service desk...")
			updateResource[#"servingTea($DestTable)"#]			
			<mevid>request mover -m moveTo : moveTo(servicedesk)</mevid>
		}
		
	}
	<tevid>Transition t0 whenReply done -> servTeaToClientPhase2</tevid>
	
	
	<sevid>State servTeaToClientPhase2</sevid> {
		
		println("waiter | bringing tea to table $DestTable...")
		[#var Dest =  "teatable" + DestTable #]
		<mevid>request mover -m moveTo : moveTo($Dest)</mevid>
			
	}
	<tevid>Transition t0 whenReply done -> servTeaToClientPhase3</tevid>
	
	<sevid>State servTeaToClientPhase3</sevid> {
		delay 1000
		<mevid>emit teaServed : teaServed($DestTable, $CurDrink )</mevid>
		<comm>//start counting for consumingTime NOW</comm>
		<comm>//start timer to count until MaxStayTime</comm>
		<mevid>forward mastertimer -m resumeTimer : resumeTimer($DestTable)</mevid>
	
	}		
	<tevid>Goto cleanTeatablePhase1 if [# WasCleaning == true #] else doATask</tevid>
	
	<comm>/****************************************************************************************************/</comm>
	
	<comm>/**************************************  WAITER HANDLE PAYMENT **************************************/</comm>
	
	<sevid>State handlePaymentPhase1</sevid>{
		
		onMsg(billPlease : billPlease(T)){
		
			if [# WasCleaning == true #]{
				[# var TempTime = 0L #]
				memoCurrentTime TempTime
				[# TimeToClean = TimeToClean - (TempTime - TimeCleanBegan) #]
				println("waiter | interrupted cleaning to handle payment request")
			}
			
			<comm>// stopping timer</comm>
			println("waiter | Client at table ${payloadArg(0)} is ready to pay. Ending timer for table ${payloadArg(0)}")
			<mevid>forward mastertimer -m endTimer : endTimer($payloadArg(0))</mevid>
			
			<comm>// reaching table</comm>
			[#
				<comm>//memorizing teatable_id for next phase</comm>
				DestTable = payloadArg(0).toInt()
				var Dest = "teatable" + payloadArg(0)
			#]
			println("waiter | Reaching table ${payloadArg(0)} ...")
			updateResource[#"handlePayment($DestTable)"#]
			<mevid>request mover -m moveTo : moveTo($Dest)</mevid>
		}
		
	}
	<tevid>Transition t0 whenReply done -> handlePaymentPhase2</tevid>
	
	
	<sevid>State handlePaymentPhase2</sevid> {
		println("waiter | Asking Client at table $DestTable to pay ...")
		delay 500
		<mevid>emit cardPlease : cardPlease($Price) </mevid>
		<comm>//get client_id from table_id</comm>
		<mevid>request tearoom -m getRoomState : getRoomState(getClientFromTable, $DestTable) </mevid>
	}
	<tevid>Transition t0 whenReply state -> convoyClientToExitPhase1</tevid>
	
	State convoyClientToExitPhase1 {
		onMsg(state : state(C)){
			println("waiter | Convoying Client ${payloadArg(0)} to exit door ...")
			[# ClientToConvoy = payloadArg(0)#]
			updateResource[#"convoyingClientToExitDoor($ClientToConvoy)"#]
			<mevid>request mover -m moveTo : moveTo(exit)</mevid>
		}
	}
	<tevid>Transition t0 whenReply done -> convoyClientToExitPhase2</tevid>
	
	<sevid>State convoyClientToExitPhase2</sevid> {
			println("waiter | saying goodbye to client $ClientToConvoy...")
			<mevid>emit exitPlease : exitPlease($ClientToConvoy)</mevid>
			
			<comm>//updating teatable state</comm>
			<mevid>forward tearoom -m updateState : updateState(updateTableState, $DestTable, dirty, ARG)</mevid>
			
			<comm>//remember to clean the table</comm>
			<mevid>forward waiter -m cleanTable : cleanTable($DestTable)</mevid>
	}
	<tevid>Goto cleanTeatablePhase1 if [# WasCleaning == true #] else doATask</tevid>
	
	<comm>/****************************************************************************************************/</comm>
	
	<comm>/**************************************  WAITER HANDLE SLOW CLIENT **************************************/</comm>
	
	
	<sevid>State handleTimeoutPhase1</sevid> {
		
		onMsg(timeout : timeout(T)){
			println("waiter | Time exceeded for client at table ${payloadArg(0)}")
			println("waiter | reaching table ${payloadArg(0)}...")
			
			[#
				DestTable = payloadArg(0).toInt()
				var Dest = "teatable" + payloadArg(0)
			#]
			updateResource[#"handlePayment($DestTable)"#]
			<mevid>request mover -m moveTo : moveTo($Dest)</mevid>
		}
	}
	<tevid>Transition t0 whenReply done -> handleTimeoutPhase2</tevid>
	
	<sevid>State handleTimeoutPhase2</sevid> {
			println("waiter | communicating to client at table ${payloadArg(0)} that he has to pay and leave...")
			<mevid>emit maxTimeExceeded : maxTimeExceeded($payloadArg(0), $Price)</mevid>
						
			<comm>//get client_id from table_id</comm>
			<mevid>request tearoom -m getRoomState : getRoomState(getClientFromTable, $DestTable)</mevid>	
			
	}
	<tevid>Transition t0 whenReply state -> convoyClientToExitPhase1</tevid>
	
}</code></pre>
			</li>
		</ul>
	</div>	
</div>

<h2>Test Plans</h2>
<div class="remark">

	<h4>Client MOK - WebGUI</h4>
	<div>
		<p>
		The only change the Client underwent was in the EventHandler: since the Waiter sends the MaxWaitTime in milliseconds, it is necessary to transform it into minutes and seconds for better readability. For the other Client GUI classes see the previous Sprint (<a href="https://htmlpreview.github.io/?https://github.com/gitemar/Martini_Drudi_ISS2020/blob/master/Sprint2_ISS2020/userDocs/Progetto_Martini_Drudi_Sprint2.html">Sprint 2</a>)
		</p>
		<p><i>EventHandler.java</i></p>
		<pre class="mytab"><code>public final class EventHandler {
	
	public static void handleWaitEvent(String message, ProvaController pc) {
		
		String [] els = getMessageElements(message, "wait");
		System.out.println("__________Waiter said that client " + els[0] + " has to wait " + els[1] + "mins");
		String resp="";
		
		try{
			<change_evid>if(Long.parseLong(els[1]) == 0L) {</change_evid>
				<change_evid>System.out.println("__________Client "+els[0]+" can enter now");</change_evid>
				<change_evid>resp="Waiter :- Please, follow me...";</change_evid>
			<change_evid>}</change_evid>
			<change_evid>else {</change_evid>
				<change_evid>long temp = Long.parseLong(els[1]);</change_evid>
				<change_evid>long minutes = temp / (1000L*60L);</change_evid>
				<change_evid>long seconds = ( temp / 1000L ) % 60L;</change_evid>
				<change_evid>System.out.println("__________Client "+els[0]+" has to wait");</change_evid>
				<change_evid>resp="You have to wait at maximum " + minutes +" minutes and "+seconds+" seconds. Please, come again later. We are sorry for the waiting...";</change_evid>
			<change_evid>}</change_evid>
			pc.updateWaiterResp(resp, "/topic/"+els[0]);
		}
		catch(Exception e) {
			e.printStackTrace();
			e.getCause();
			System.err.println("ERRORE");
		}
		
	}
	
	public static void handleSitEvent(String message, ProvaController pc) {
		
		String[] elements = getMessageElements(message.toString(),"sitPlease");
		int table = Integer.parseInt(elements[1]) -1;
		pc.getTavoliClienti()[table] = elements[0];
		System.out.println("__________________Client "+elements[0]+" was brought to teatable "+elements[1]);
		pc.updateWaiterResp("showmenu", "/topic/"+elements[0]);
		
	}
	
	public static void handleOrderEvent(String message, ProvaController pc) {
		
		String[] elements = getMessageElements(message.toString(),"orderPlease");
		System.out.println("__________________Client at teatable "+ elements[0] +" can now order");
		pc.updateWaiterResp("orderplease", "/topic/"+elements[0]);
		
	}
	
	public static void handleTeaServedEvent(String message, ProvaController pc) {
		
		String[] elements = getMessageElements(message.toString(),"teaServed");
		System.out.println("__________________"+elements[1]+" tea was brought to teatable "+elements[0]);
		pc.updateWaiterResp("teaserved", "/topic/"+elements[0]);
		
	}
	
	public static void handleCardEvent(String message, ProvaController pc) {
		
		String[] elements = getMessageElements(message.toString(),"cardPlease");
		System.out.println("__________________Client at teatable "+ elements[0] +" can now pay");
		pc.updateWaiterResp("cardplease", "/topic/"+elements[0]);
		
	}
	
	public static void handleMaxTimeExceededEvent(String message, ProvaController pc) {
		
		String[] elements = getMessageElements(message.toString(),"maxTimeExceeded");
		System.out.println("__________________Max time exceeded for teatable "+ elements[0]);
		int table = Integer.parseInt(elements[0]);
		String id=pc.getTavoliClienti()[ table - 1];
		pc.updateWaiterResp("maxtime", "/topic/"+id);
		
	}
	
	public static void handleExitEvent(String message, ProvaController pc) {
		
		String[] elements = getMessageElements(message.toString(),"exitPlease");
		System.out.println("__________________Client "+elements[0]+" can now leave ");
		pc.updateWaiterResp("exitplease", "/topic/"+elements[0]);
		
	}
	
	public static String[] getMessageElements(String message, String kw) {
		
		String waiterEvent = KotParser.getMessageArg(message,kw);
		System.out.println("_________________________MqttClient "+kw+" event arrived | "+waiterEvent);
		String[] elements = KotParser.getPayloadElements(waiterEvent);
		
		return elements;
		
	}

}</code></pre>
		
	</div>
	<h4>Testing with client in action</h4>
	<p>Hereunder is reported a video showing the waiter in action while managing two client inside the tearoom and, since there is no free and clean table, denying access to a third client that want to enter.</p>
	<center><video width="80%" controls>
		<source src="./video/threeclients.mp4" type="video/mp4">
		<source src="./video/threeclients.ogg" type="video/ogg">
		Your browser does not support the video tag.
	</video></center>
	
	<!--<h4>Automated Test Plans</h4>-->
</div>

</div>



 <!--------------------------------------------------------------------------------------------------------------------------------->

<table id="authors" border="1" align="center">
<tr>
<td style="width:50%">
<center>By Elena Martini ~ email: elena.martini6@studio.unibo.it</center> 
</td>
<td style="width:50%">
<center>By Elisa Drudi ~ email: elisa.drudi4@studio.unibo.it </center>
</td>
</tr>
<!-- ---------------->
<tr>
<td style="width:50%">
<center><img src="./img/elena.jpg" alt="mbot" width="100%"></center>
</td>
<td style="width:50%">
<center><img src="./img/elisa.jpg" alt="mbot" width="100%"></center>
</td>
</tr>
</table>  
</body>
</html>

<html><head><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"><meta name="Robots" content="NOINDEX " /></head><body></body>
                <script type="text/javascript">
                 var gearPage = document.getElementById('GearPage');
                 if(null != gearPage)
                 {
                     gearPage.parentNode.removeChild(gearPage);
                     document.title = "Error";
                 }
                 </script>
</html>